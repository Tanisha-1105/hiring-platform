{% extends 'base.html' %}

{% block title %}Chat with {{ 'Mentor' if user_role == 'candidate' else 'Candidate' }}{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Chat Header -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">
                                <i class="bi bi-chat-dots me-2"></i>
                                {% if user_role == 'candidate' %}
                                    Chat with Mentor
                                {% else %}
                                    Chat with Candidate
                                {% endif %}
                            </h5>
                            {% if user_role == 'candidate' %}
                                <small class="d-block fw-semibold">{{ request.mentor_name }}</small>
                                <small class="d-block text-white-75">{{ request.mentor_email }}</small>
                            {% else %}
                                <small class="d-block fw-semibold">{{ request.candidate_name }}</small>
                                <small class="d-block text-white-75">{{ request.candidate_email }}</small>
                            {% endif %}
                            <small class="d-block text-white-50">Session role: {{ user_role|title }}</small>
                            {% if request.expertise and request.company %}
                            <small class="d-block text-white-75">Expertise: {{ request.expertise }} @ {{ request.company }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <a href="{{ '/candidate-dashboard#mentors' if user_role == 'candidate' else '/mentor-dashboard' }}" 
                               class="btn btn-sm btn-light">
                                <i class="bi bi-arrow-left me-1"></i>Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meeting Schedule Card -->
            {% if meeting %}
            <div class="card shadow-sm mb-3 border-success">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-check text-success me-2"></i>Scheduled Meeting</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Date:</strong> {{ meeting.meeting_date_formatted or meeting.meeting_date }}</p>
                            <p class="mb-1"><strong>Time:</strong> {{ meeting.meeting_time_formatted or meeting.meeting_time }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Mode:</strong> {{ meeting.mode }}</p>
                            {% if meeting.meeting_link %}
                            <p class="mb-1">
                                <strong>Link:</strong> 
                                <a href="{{ meeting.meeting_link }}" target="_blank" class="btn btn-sm btn-success">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>Join Meeting
                                </a>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% if meeting.notes %}
                    <p class="mt-2 mb-0"><strong>Notes:</strong> {{ meeting.notes }}</p>
                    {% endif %}
                </div>
            </div>
            {% elif user_role == 'mentor' %}
            <div class="card shadow-sm mb-3 border-warning">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-x text-warning me-2"></i>No Meeting Scheduled</h6>
                    <p class="mb-2">Schedule a meeting with your mentee to get started.</p>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleMeetingModal">
                        <i class="bi bi-calendar-plus me-1"></i>Schedule Meeting
                    </button>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>Your mentor will schedule a meeting soon.
            </div>
            {% endif %}

            <!-- Chat Messages -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div id="chat-messages" class="p-3" style="height: 450px; overflow-y: auto; background-color: #f8f9fa;">
                        {% if messages %}
                            {% for msg in messages %}
                            <div class="message-bubble mb-3 {% if msg.sender_role == user_role %}text-end{% endif %}">
                                <div class="d-inline-block" style="max-width: 70%;">
                                    <div class="{% if msg.sender_role == user_role %}bg-primary text-white{% else %}bg-white border{% endif %} p-3 rounded-3">
                                        <p class="mb-1">{{ msg.message_text }}</p>
                                        <small class="{% if msg.sender_role == user_role %}text-white-50{% else %}text-muted{% endif %}">
                                            {{ msg.created_at.strftime('%I:%M %p') }}
                                        </small>
                                    </div>
                                    <small class="{% if msg.sender_role == user_role %}text-end{% endif %} d-block mt-1 text-muted">
                                        {{ msg.sender_name }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-text" style="font-size: 3rem;"></i>
                            <p class="mt-2">No messages yet. Start the conversation!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <form id="message-form" class="d-flex gap-2">
                        <input type="text" 
                               id="message-input" 
                               class="form-control" 
                               placeholder="Type your message..." 
                               required>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Meeting Modal (Mentor Only) -->
{% if user_role == 'mentor' %}
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Schedule Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="schedule-meeting-form">
                    <div class="mb-3">
                        <label class="form-label">Meeting Mode</label>
                        <select class="form-select" name="mode" required>
                            <option value="Online">Online</option>
                            <option value="Weekdays">Weekdays</option>
                            <option value="Weekends">Weekends</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Meeting Date</label>
                        <input type="date" class="form-control" name="meeting_date" required 
                               min="{{ (now + timedelta(days=1)).strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Meeting Time</label>
                        <input type="time" class="form-control" name="meeting_time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Meeting Link (Optional)</label>
                        <input type="url" class="form-control" name="meeting_link" 
                               placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" name="notes" rows="2" 
                                  placeholder="Add any additional information..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scheduleMeeting()">
                    <i class="bi bi-check-lg me-1"></i>Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
const mentorshipRequestId = {{ request.id }};
const userRole = '{{ user_role }}';

// Join the room for this mentorship
socket.emit('join', {room: 'mentorship_' + mentorshipRequestId});

// Send message
document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    
    if (!messageText) return;
    
    fetch('/send-mentor-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mentorship_request_id: mentorshipRequestId,
            message: messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            // Message will be added via socket
        } else {
            alert(data.message || 'Failed to send message');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send message');
    });
});

// Listen for new messages
socket.on('new_mentor_message', function(data) {
    if (data.mentorship_request_id == mentorshipRequestId) {
        addMessageToChat(data);
        scrollToBottom();
    }
});

function addMessageToChat(data) {
    const chatMessages = document.getElementById('chat-messages');
    const isOwnMessage = data.sender_role === userRole;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-bubble mb-3 ' + (isOwnMessage ? 'text-end' : '');
    messageDiv.innerHTML = '<div class="d-inline-block" style="max-width: 70%;"><div class="' + 
        (isOwnMessage ? 'bg-primary text-white' : 'bg-white border') + 
        ' p-3 rounded-3"><p class="mb-1">' + escapeHtml(data.message_text) + 
        '</p><small class="' + (isOwnMessage ? 'text-white-50' : 'text-muted') + '">' + 
        data.created_at + '</small></div><small class="' + 
        (isOwnMessage ? 'text-end' : '') + ' d-block mt-1 text-muted">' + 
        data.sender_name + '</small></div>';
    
    chatMessages.appendChild(messageDiv);
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Schedule meeting (mentor only)
{% if user_role == 'mentor' %}
function scheduleMeeting() {
    const form = document.getElementById('schedule-meeting-form');
    const formData = new FormData(form);
    
    const data = {
        candidate_id: '{{ request.candidate_id }}',
        mode: formData.get('mode'),
        meeting_date: formData.get('meeting_date'),
        meeting_time: formData.get('meeting_time'),
        meeting_link: formData.get('meeting_link'),
        notes: formData.get('notes')
    };
    
    fetch('/schedule-mentor-meeting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Meeting scheduled successfully!');
            location.reload();
        } else {
            alert(data.message || 'Failed to schedule meeting');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to schedule meeting');
    });
}
{% endif %}

// Scroll to bottom on load
window.addEventListener('load', scrollToBottom);
</script>

<style>
#chat-messages::-webkit-scrollbar {
    width: 8px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.message-bubble {
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
