<!-- Mentor Dashboard Template -->
{% extends "base.html" %}
{% block title %}Mentor Dashboard | HireHub{% endblock %}
{% block content %}
<div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
</div>
<div class="container-fluid">
    <div class="row">

        <div class="col-md-3 mentor-sidebar">
            <h5 class="sidebar-title"><i class="bi bi-mortarboard-fill me-2"></i> Mentor Panel</h5>
            
            <a href="#dashboard" class="sidebar-link active" data-section="dashboard">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>

            {% if profile_completed %}
                <a href="#profile" class="sidebar-link" data-section="profile">
                    <i class="bi bi-person-circle me-2"></i> My Profile
                </a>
                <a href="#requests" class="sidebar-link" data-section="requests">
                    <i class="bi bi-inbox-fill me-2"></i> Mentorship Requests
                </a>
                <a href="#mentees" class="sidebar-link" data-section="mentees">
                    <i class="bi bi-people me-2"></i> Active Mentees
                </a>
                <a href="#notifications" class="sidebar-link" data-section="notifications">
                    <i class="bi bi-bell me-2"></i> Notifications
                </a>
                <a href="#schedule" class="sidebar-link" data-section="schedule">
                    <i class="bi bi-calendar-event me-2"></i> My Schedule
                </a>
                <a href="#feedback" class="sidebar-link" data-section="feedback">
                    <i class="bi bi-star-fill me-2"></i> Feedback Given
                </a>
            {% else %}
                <a href="#profile" class="sidebar-link" data-section="profile">
                    <i class="bi bi-pencil-square me-2"></i> Complete Profile
                </a>
                <div class="px-3 mt-3">
                    <span class="badge bg-light text-dark w-100 p-2 shadow-sm" style="white-space: normal;">
                        Complete Profile to Unlock All Features
                    </span>
                </div>
            {% endif %}
            
            <hr>
            <a href="/logout" class="sidebar-link logout"><i class="bi bi-door-open me-2"></i> Logout</a>
        </div>


        <div class="col-md-9 p-5">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold"><i class="bi bi-person-workspace me-2"></i>Welcome Mentor</h3>
                    <p class="text-muted mb-0">Manage your profile & mentorship</p>
                </div>

                {% if profile %}
                    {% if profile.verification_status == 'approved' %}
                        <span class="badge bg-success fs-6">Verified Mentor</span>
                    {% elif profile.verification_status == 'rejected' %}
                            <span class="badge bg-danger fs-6">Rejected</span>
                            {% if profile.rejection_reason %}
                                <div class="alert alert-danger mt-3">Your verification was rejected: <strong>{{ profile.rejection_reason }}</strong></div>
                            {% endif %}
                    {% else %}
                        <span class="badge bg-warning text-dark fs-6">Pending Verification</span>
                    {% endif %}
                {% endif %}
            </div>

            <div class="card p-4 mb-4 shadow-sm">
                <h6 class="fw-semibold mb-2">Profile Completion</h6>
                <div class="progress">
                    <div class="progress-bar bg-success"
                        id="completion-bar"
                        style="width: {{ profile_percent }}%"
                        data-auto="{{ 'false' if profile_completed else 'true' }}">
                        {{ profile_percent }}%
                    </div>
                </div>
            </div>
                    <div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-md">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="chatModalLabel">Live Chat</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <ul class="list-group mb-3" id="chatLog" style="max-height: 280px; overflow-y: auto;"></ul>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="chatInput" placeholder="Type a message...">
                                        <button class="btn btn-primary" type="button" id="chatSend">Send</button>
                                    </div>
                                    <small class="text-muted d-block mt-2">Chat is scoped per mentee. Server-side chat handling is needed for real-time sync.</small>
                                </div>
                            </div>
                        </div>
                    </div>

            <div class="dashboard-section active-section" id="dashboard">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card p-4 shadow-sm border-0 bg-primary text-white">
                            <h6>Active Mentees</h6>
                            <h2>{{ active_sessions|length if active_sessions else 0 }}</h2>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 shadow-sm border-0 bg-info text-white">
                            <h6>Pending Requests</h6>
                            <h2>{{ pending_requests|length if pending_requests else 0 }}</h2>
                        </div>
                    </div>
                </div>
                <div class="mt-4 card p-4 shadow-sm">
                    <h5>Overview</h5>
                    <p>Welcome to your dashboard. Select an option from the sidebar to manage your mentorship journey.</p>
                </div>
            </div>

            <div class="card shadow-sm p-4 dashboard-section" id="profile">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">My Mentor Profile</h4>
                    <div id="profile-actions">
                        {% if profile %}
                            <button class="btn btn-outline-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#viewProfileModal">
                                <i class="bi bi-eye me-1"></i> View Profile
                            </button>
                            {% if profile.verification_status == 'rejected' %}
                                <button class="btn btn-warning btn-sm me-2" onclick="toggleEditMode(true)">
                                    <i class="bi bi-pencil-square me-1"></i> Edit Profile According to Feedback
                                </button>
                            {% endif %}
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleEditMode(true)">
                                <i class="bi bi-pencil me-1"></i> Edit Profile
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteProfile()">
                                <i class="bi bi-trash me-1"></i> Delete Profile
                            </button>
                        {% endif %}
                    </div>
                </div>

                <div id="view-mode" class="{% if not profile %}d-none{% endif %}">
                    <div class="row mb-4">
                        <div class="col-md-3 text-center">
                            {% if profile.photo_file %}
                                <img src="{{ url_for('static', filename='uploads/' ~ profile.photo_file) }}" alt="Profile Photo" class="img-fluid rounded-circle mb-2" style="width:120px;height:120px;object-fit:cover;">
                            {% else %}
                                <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width:120px;height:120px;">No Photo</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Expertise</p>
                            <p class="fw-bold">{{ profile.expertise if profile }}</p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Designation</p>
                            <p class="fw-bold">{{ profile.designation if profile }}</p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted mb-1">Company</p>
                            <p class="fw-bold">{{ profile.company if profile }}</p>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <p class="text-muted mb-1">Short Bio</p>
                            <p>{{ profile.bio if profile }}</p>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">LinkedIn Profile</p>
                            <a href="{{ profile.linkedin if profile }}" target="_blank" class="btn btn-link p-0 text-decoration-none">
                                <i class="bi bi-linkedin me-1"></i> View LinkedIn
                            </a>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Mentoring Areas</p>
                            <p class="fw-semibold">{{ profile.mentoring_areas if profile }}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted d-block">Session Mode</small>
                            <span>{{ profile.mode if profile }}</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Available Days</small>
                            <span>{{ profile.available_days if profile }}</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Time Slot</small>
                            <span>{{ profile.time_slot if profile }}</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Experience</small>
                            <span>{{ profile.experience if profile }} Years</span>
                        </div>
                    </div>
                </div>

                <div id="edit-mode" class="{% if profile %}d-none{% endif %}">
                    <form method="POST" action="/mentor-dashboard" enctype="multipart/form-data" id="mentorForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Expertise *</label>
                                <input type="text" name="expertise" class="form-control track" value="{{ profile.expertise if profile else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Designation *</label>
                                <input type="text" name="designation" class="form-control track" value="{{ profile.designation if profile else '' }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Company *</label>
                                <input type="text" name="company" class="form-control track" value="{{ profile.company if profile else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>LinkedIn Profile *</label>
                                <input type="url" name="linkedin" class="form-control track" value="{{ profile.linkedin if profile else '' }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Industry Exp (Years)</label>
                                <input type="number" name="experience" class="form-control track" value="{{ profile.experience if profile else '' }}" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Mentoring Exp (Years)</label>
                                <input type="number" name="mentoring_experience" class="form-control track" value="{{ profile.mentoring_experience if profile else '' }}" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Max Candidates</label>
                                <input type="number" name="max_candidates" class="form-control track" value="{{ profile.max_candidates if profile else '' }}" min="1">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Mentoring Areas *</label>
                            <textarea name="mentoring_areas" class="form-control track" rows="3" required>{{ profile.mentoring_areas if profile else '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Session Mode *</label>
                                <select name="mode" class="form-select track" required>
                                    <option value="Online" {% if profile and profile.mode == 'Online' %}selected{% endif %}>Online</option>
                                    <option value="Offline" {% if profile and profile.mode == 'Offline' %}selected{% endif %}>Offline</option>
                                    <option value="Hybrid" {% if profile and profile.mode == 'Hybrid' %}selected{% endif %}>Hybrid</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Available Days *</label>
                                <select name="available_days" class="form-select track" required>
                                    <option value="Weekdays" {% if profile and profile.available_days == 'Weekdays' %}selected{% endif %}>Weekdays</option>
                                    <option value="Weekends" {% if profile and profile.available_days == 'Weekends' %}selected{% endif %}>Weekends</option>
                                    <option value="All Days" {% if profile and profile.available_days == 'All Days' %}selected{% endif %}>All Days</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Time Slot *</label>
                                <input type="text" name="time_slot" class="form-control track" value="{{ profile.time_slot if profile else '' }}" placeholder="6 PM – 9 PM" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Short Bio *</label>
                            <textarea name="bio" class="form-control track" rows="3" required>{{ profile.bio if profile else '' }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Verification Type *</label>
                                <select name="verification_type" class="form-select track" required>
                                    <option value="Company ID" {% if profile and profile.verification_type == 'Company ID' %}selected{% endif %}>Company ID</option>
                                    <option value="Degree Certificate" {% if profile and profile.verification_type == 'Degree Certificate' %}selected{% endif %}>Degree Certificate</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Verification Document</label>
                                <input type="file" name="verification_file" class="form-control track" accept=".pdf,.jpg,.jpeg,.png">
                                <small class="text-muted">Leave empty to keep existing document</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Profile Photo</label>
                                <input type="file" name="photo" class="form-control track" accept="image/*">
                                <small class="text-muted">JPEG/PNG. Leave empty to keep existing photo</small>
                            </div>
                        </div>

                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1">
                                <i class="bi bi-save me-1"></i> Save Profile Changes
                            </button>
                            {% if profile %}
                                <button type="button" class="btn btn-secondary" onclick="toggleEditMode(false)">Cancel</button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <div class="card p-4 shadow-sm dashboard-section" id="requests">
                <h4 class="mb-3">Mentorship Requests</h4>
                {% if pending_requests %}
                <div class="table-responsive">
                    <table class="table table-hover border">
                        <thead class="table-light">
                            <tr>
                                <th>Candidate</th>
                                <th>Message</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in pending_requests %}
                            <tr>
                                <td>
                                    <strong>{{ r.candidate_name }}</strong><br>
                                    <small class="text-muted">{{ r.candidate_email }}</small>
                                </td>
                                <td>{{ r.request_message[:100] }}{% if r.request_message|length > 100 %}...{% endif %}</td>
                                <td>
                                    <button class="btn btn-sm btn-info mb-1" data-bs-toggle="modal" data-bs-target="#candidateProfileModal{{ r.id }}">
                                        <i class="bi bi-eye me-1"></i>View Profile
                                    </button><br>
                                    <a href="/mentor/respond-request/{{ r.id }}/accept" class="btn btn-sm btn-success me-1">Accept</a>
                                    <a href="/mentor/respond-request/{{ r.id }}/reject" class="btn btn-sm btn-danger">Reject</a>
                                </td>
                            </tr>
                            
                            <!-- Candidate Profile Modal -->
                            <div class="modal fade" id="candidateProfileModal{{ r.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header bg-info text-white">
                                            <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i>{{ r.candidate_name }}'s Profile</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body p-4">
                                            <div class="row mb-3">
                                                <div class="col-md-3 text-center">
                                                    {% if r.photo_file %}
                                                        <img src="{{ url_for('static', filename='uploads/' + r.photo_file) }}" alt="Profile Photo" class="img-fluid rounded-circle mb-2" style="width:100px;height:100px;object-fit:cover;">
                                                    {% else %}
                                                        <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width:100px;height:100px;font-size:40px;">
                                                            {{ r.candidate_name[0]|upper }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-9">
                                                    <h5>{{ r.first_name }} {{ r.last_name }}</h5>
                                                    <p class="text-muted mb-1"><i class="bi bi-envelope me-1"></i>{{ r.candidate_email }}</p>
                                                    {% if r.headline %}
                                                        <p class="text-primary fw-semibold"><i class="bi bi-briefcase me-1"></i>{{ r.headline }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            {% if r.bio %}
                                            <div class="mb-3">
                                                <strong class="text-muted small">About</strong>
                                                <p class="border-start border-3 ps-3">{{ r.bio }}</p>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong class="text-muted small">Education</strong>
                                                    <p>{{ r.education if r.education else 'Not provided' }}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong class="text-muted small">Skills</strong>
                                                    <p>{{ r.skills if r.skills else 'Not provided' }}</p>
                                                </div>
                                            </div>
                                            
                                            {% if r.experience %}
                                            <div class="mb-3">
                                                <strong class="text-muted small">Experience</strong>
                                                <p>{{ r.experience }}</p>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="bg-light p-3 rounded">
                                                <strong class="text-muted small d-block mb-2">Request Message:</strong>
                                                <p class="mb-0">{{ r.request_message }}</p>
                                            </div>
                                        </div>
                                        <div class="modal-footer bg-light">
                                            {% if r.resume_file %}
                                                <a href="{{ url_for('static', filename='uploads/' + r.resume_file) }}" target="_blank" class="btn btn-primary btn-sm">
                                                    <i class="bi bi-file-earmark-pdf me-1"></i>View Resume
                                                </a>
                                            {% endif %}
                                            <a href="/mentor/respond-request/{{ r.id }}/accept" class="btn btn-success btn-sm">
                                                <i class="bi bi-check-circle me-1"></i>Accept Request
                                            </a>
                                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-muted">No pending requests</p>
                {% endif %}
            </div>

            <div class="card p-4 shadow-sm dashboard-section" id="mentees">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Active Mentorship Sessions</h4>
                    <small class="text-muted">Chat and feedback with your accepted mentees</small>
                </div>

                {% if active_sessions %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Candidate</th>
                                <th>Email</th>
                                <th>Request</th>
                                <th>Started</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in active_sessions %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ s.candidate_name }}</td>
                                <td><a href="mailto:{{ s.candidate_email }}">{{ s.candidate_email }}</a></td>
                                <td class="text-muted small" style="max-width: 260px;">{{ s.request_message }}</td>
                                <td class="text-muted small">{{ s.started_at.strftime('%Y-%m-%d %H:%M') if s.started_at }}</td>
                                <td class="d-flex flex-wrap gap-2 align-items-center">
                                    <button class="btn btn-sm btn-outline-primary chat-btn"
                                        data-room="mentor_{{ user_id }}_cand_{{ s.candidate_id }}"
                                        data-mentee="{{ s.candidate_name }}">
                                        <i class="bi bi-chat-dots"></i> Chat
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary schedule-btn"
                                        data-room="mentor_{{ user_id }}_cand_{{ s.candidate_id }}"
                                        data-mentee="{{ s.candidate_name }}">
                                        <i class="bi bi-calendar-event"></i> Schedule
                                    </button>
                                    <button class="btn btn-sm btn-outline-success feedback-btn"
                                        data-request-id="{{ s.id }}">
                                        <i class="bi bi-send"></i> Feedback
                                    </button>
                                    <span class="badge bg-info text-dark meeting-badge d-none"></span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info small d-flex align-items-center gap-2 mt-3">
                    <i class="bi bi-info-circle"></i>
                    Chat is scoped per mentee. Messages stay within each room (mentor + that candidate).
                </div>
                {% else %}
                    <p class="text-muted">No active mentorship sessions</p>
                {% endif %}
            </div>

            <div class="card p-4 shadow-sm dashboard-section" id="schedule">
                <h4 class="mb-3">My Schedule</h4>
                <div id="scheduleContainer">
                    <div class="alert alert-secondary">No scheduled meetings yet.</div>
                </div>
                
                <div class="mt-4 alert alert-info">
                    <strong>Profile Availability:</strong><br>
                    <small>
                        Mode: <strong>{{ profile.mode if profile else 'N/A' }}</strong><br>
                        Days: <strong>{{ profile.available_days if profile else 'N/A' }}</strong><br>
                        Time Slot: <strong>{{ profile.time_slot if profile else 'N/A' }}</strong>
                    </small>
                </div>
            </div>

            <div class="card p-4 shadow-sm dashboard-section" id="feedback">
                <h4 class="mb-3">Feedback Given</h4>
                <p class="text-muted">History of feedback submitted to mentees.</p>
            </div>

            <div class="card p-4 shadow-sm dashboard-section" id="notifications">
                <h4 class="mb-3">Notifications</h4>
                {% if notifications %}
                    {% for n in notifications %}
                        <div class="alert alert-info py-2 shadow-sm">{{ n.message }}</div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No new notifications</p>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="scheduleModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Mode</label>
                    <select class="form-select" id="meetingMode">
                        <option value="Zoom Call">Zoom Call</option>
                        <option value="Google Meet">Google Meet</option>
                        <option value="Messaging">Messaging</option>
                        <option value="Phone">Phone</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="meetingDate">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="meetingTime">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Meeting Link (Zoom/Meet)</label>
                    <input type="url" class="form-control" id="meetingLink" placeholder="https://zoom.us/... or https://meet.google.com/...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" rows="2" id="meetingNotes" placeholder="Agenda, prep notes, etc."></textarea>
                </div>
                <div class="alert alert-info small">
                    Saved locally per mentee. Share the link/time via chat or email.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveMeeting">Save</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="viewProfileModal" tabindex="-1" aria-labelledby="viewProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewProfileModalLabel"><i class="bi bi-person-badge me-2"></i>Full Mentor Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="text-muted small text-uppercase fw-bold">Designation & Company</label>
                        <p class="fs-5">{{ profile.designation if profile }} at {{ profile.company if profile }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small text-uppercase fw-bold">Primary Expertise</label>
                        <p class="fs-5 text-primary">{{ profile.expertise if profile }}</p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-muted small text-uppercase fw-bold">About Me</label>
                    <p class="border-start border-3 ps-3 italic">{{ profile.bio if profile }}</p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="text-muted small text-uppercase fw-bold">Mentoring Focus</label>
                        <p>{{ profile.mentoring_areas if profile }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small text-uppercase fw-bold">Availability</label>
                        <p>{{ profile.available_days if profile }} | {{ profile.time_slot if profile }}</p>
                    </div>
                </div>

                <div class="bg-light p-3 rounded d-flex justify-content-around text-center">
                    <div>
                        <span class="d-block text-muted small">Experience</span>
                        <span class="fw-bold">{{ profile.experience if profile }} Years</span>
                    </div>
                    <div>
                        <span class="d-block text-muted small">Mentoring Exp</span>
                        <span class="fw-bold">{{ profile.mentoring_experience if profile }} Years</span>
                    </div>
                    <div>
                        <span class="d-block text-muted small">Max Mentees</span>
                        <span class="fw-bold">{{ profile.max_candidates if profile }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <a href="{{ profile.linkedin if profile }}" target="_blank" class="btn btn-primary btn-sm">
                    <i class="bi bi-linkedin me-1"></i> Visit LinkedIn
                </a>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const socket = io();
        const userId = {{ user_id | tojson }};
        const chatModal = document.getElementById('chatModal');
        const chatTitle = document.getElementById('chatModalLabel');
        const chatLog = document.getElementById('chatLog');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSend');
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleTitle = document.getElementById('scheduleModalLabel');
        const meetingMode = document.getElementById('meetingMode');
        const meetingDate = document.getElementById('meetingDate');
        const meetingTime = document.getElementById('meetingTime');
        const meetingLink = document.getElementById('meetingLink');
        const meetingNotes = document.getElementById('meetingNotes');
        const saveMeetingBtn = document.getElementById('saveMeeting');
        let currentRoom = null;
        let currentPeer = '';
        const localMessages = {}; // simple client-side log per room
        let meetingCache = {}; // server-backed cache keyed by room

        socket.on('connect', () => {
            socket.emit('join', { role: 'mentor', id: userId });
        });

        socket.on('mentor_notification', (data) => {
            const msg = data.message || 'You have a new notification';
            const container = document.querySelector('#notifications');
            if (!container) return;
            const alert = document.createElement('div');
            alert.className = 'alert alert-info py-2 shadow-sm';
            alert.textContent = msg;
            const cardBody = container.querySelector('.card-body') || container;
            cardBody.prepend(alert);
        });

        const loadMeetings = async () => {
            try {
                const res = await fetch('/api/mentor/meetings');
                const data = await res.json();
                if (data.success && Array.isArray(data.meetings)) {
                    meetingCache = {};
                    data.meetings.forEach(m => {
                        const room = `mentor_${userId}_cand_${m.candidate_id}`;
                        meetingCache[room] = {
                            mode: m.mode,
                            date: m.meeting_date,
                            time: m.meeting_time,
                            link: m.meeting_link,
                            notes: m.notes,
                            mentee_name: m.candidate_name
                        };
                    });
                    hydrateMeetingBadge();
                    populateSchedule();
                }
            } catch (e) {
                console.warn('Could not load meetings', e);
            }
        };

        // Basic chat UI (front-end only unless server handles chat events)
        const renderMessages = () => {
            chatLog.innerHTML = '';
            const msgs = localMessages[currentRoom] || [];
            msgs.forEach(m => {
                const li = document.createElement('li');
                li.className = 'list-group-item py-1';
                li.innerHTML = `<strong>${m.author}:</strong> ${m.text}`;
                chatLog.appendChild(li);
            });
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const openChat = (room, peer) => {
            currentRoom = room;
            currentPeer = peer;
            chatTitle.textContent = `Live Chat • ${peer}`;
            if (!localMessages[currentRoom]) localMessages[currentRoom] = [];
            renderMessages();
            const modal = bootstrap.Modal.getOrCreateInstance(chatModal);
            modal.show();
        };

        const hydrateMeetingBadge = () => {
            document.querySelectorAll('.schedule-btn').forEach(btn => {
                const room = btn.dataset.room;
                const badge = btn.parentElement.querySelector('.meeting-badge');
                const entry = meetingCache[room];
                if (badge) {
                    if (entry) {
                        badge.classList.remove('d-none');
                        badge.textContent = `${entry.date || ''} ${entry.time || ''} (${entry.mode || ''})`.trim();
                    } else {
                        badge.classList.add('d-none');
                    }
                }
            });
        };

        const openSchedule = (room, peer) => {
            currentRoom = room;
            currentPeer = peer;
            scheduleTitle.textContent = `Schedule • ${peer}`;
            const entry = meetingCache[room] || {};
            meetingMode.value = entry.mode || 'Zoom Call';
            meetingDate.value = entry.date || '';
            meetingTime.value = entry.time || '';
            meetingLink.value = entry.link || '';
            meetingNotes.value = entry.notes || '';
            const modal = bootstrap.Modal.getOrCreateInstance(scheduleModal);
            modal.show();
        };

        chatSendBtn?.addEventListener('click', () => {
            const text = chatInput.value.trim();
            if (!text || !currentRoom) return;
            // Local echo; replace with socket emit if backend supports chat
            localMessages[currentRoom].push({ author: 'You', text });
            renderMessages();
            chatInput.value = '';
        });

        saveMeetingBtn?.addEventListener('click', async () => {
            if (!currentRoom) return;
            const payload = {
                candidate_id: currentRoom.split('_cand_')[1],
                mode: meetingMode.value,
                date: meetingDate.value,
                time: meetingTime.value,
                link: meetingLink.value,
                notes: meetingNotes.value
            };
            try {
                const res = await fetch('/api/mentor/meetings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'Failed to save meeting');
                // update cache and UI
                meetingCache[currentRoom] = {
                    mode: payload.mode,
                    date: payload.date,
                    time: payload.time,
                    link: payload.link,
                    notes: payload.notes,
                    mentee_name: data.meeting.candidate_name || payload.candidate_id
                };
                hydrateMeetingBadge();
                populateSchedule();
                const modal = bootstrap.Modal.getOrCreateInstance(scheduleModal);
                modal.hide();
            } catch (e) {
                alert('Could not save meeting: ' + e.message);
            }
        });

        document.querySelectorAll('.chat-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const room = btn.dataset.room;
                const mentee = btn.dataset.mentee || 'Mentee';
                openChat(room, mentee);
            });
        });

        document.querySelectorAll('.schedule-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const room = btn.dataset.room;
                const mentee = btn.dataset.mentee || 'Mentee';
                openSchedule(room, mentee);
            });
        });

        await loadMeetings();
        hydrateMeetingBadge();

    // Populate the My Schedule section with scheduled meetings
    const populateSchedule = () => {
      const container = document.getElementById('scheduleContainer');
      if (!container) return;
      
            const meetings = Object.entries(meetingCache || {});
      if (meetings.length === 0) {
        container.innerHTML = '<div class="alert alert-secondary">No scheduled meetings yet.</div>';
        return;
      }
      
      let html = '<div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>#</th><th>Mentee</th><th>Mode</th><th>Date & Time</th><th>Link</th><th>Notes</th></tr></thead><tbody>';
      meetings.forEach((entry, idx) => {
                const [room, meeting] = entry;
                const menteeMatch = room.match(/_cand_(\d+)$/);
                const menteeNum = idx + 1;
                const menteeName = meeting.mentee_name || `Mentee ${menteeMatch ? menteeMatch[1] : ''}`;
        const dateTime = meeting.date && meeting.time ? `${meeting.date} ${meeting.time}` : 'Not set';
        const link = meeting.link ? `<a href="${meeting.link}" target="_blank" class="btn btn-sm btn-outline-primary">Join</a>` : 'N/A';
        const notes = meeting.notes ? `<small>${meeting.notes.substring(0, 50)}${meeting.notes.length > 50 ? '...' : ''}</small>` : 'N/A';
        
        html += `<tr>
          <td>${menteeNum}</td>
                    <td><strong>${menteeName}</strong></td>
          <td>${meeting.mode || 'N/A'}</td>
          <td>${dateTime}</td>
          <td>${link}</td>
          <td>${notes}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    };
    
    populateSchedule();

    } catch (err) {
        console.error(err);
    }
});
</script>
<style>
    /* Section Logic: Hide all by default, show active */
    .dashboard-section {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }
    .active-section {
        display: block !important;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Mentor Sidebar Styling */
    .mentor-sidebar {
        background: linear-gradient(180deg, #0d6efd, #0b5ed7);
        min-height: 100vh;
        padding: 20px;
        color: #fff;
        position: sticky;
        top: 0;
    }

    .sidebar-title {
        font-weight: 600;
        margin-bottom: 25px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 15px;
    }

    .sidebar-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 15px;
        margin-bottom: 8px;
        color: #e9f0ff;
        text-decoration: none !important;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s ease;
    }

    .sidebar-link:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
    }

    .sidebar-link.active {
        background: rgba(255, 255, 255, 0.25);
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .sidebar-link.logout { color: #ffdddd; margin-top: 20px; }
    .sidebar-link.logout:hover { background: rgba(220, 53, 69, 0.2); }
    
    html { scroll-behavior: smooth; }
    /* Add this to your <style> block in mentor_dashboard.html */
    .alert {
        position: relative;
        z-index: 1050; /* Ensures it stays above other dashboard elements */
        margin-bottom: 20px;
    }
    
    .hover-shadow {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .hover-shadow:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".sidebar-link");
    const sections = document.querySelectorAll(".dashboard-section");
    const bar = document.getElementById("completion-bar");
    const fields = document.querySelectorAll(".track");

    // SECTION SWITCHING LOGIC ---
    function showSection(id) {
        sections.forEach(sec => sec.classList.remove("active-section"));
        const target = document.getElementById(id);
        if (target) {
            target.classList.add("active-section");
        }
        links.forEach(link => {
            link.classList.remove("active");
            if(link.getAttribute("href") === "#" + id) {
                link.classList.add("active");
            }
        });
    }

    // Handle clicks on sidebar links
    links.forEach(link => {
        link.addEventListener("click", e => {
            const hash = link.getAttribute("href");
            if (hash && hash.startsWith("#")) {
                e.preventDefault();
                const id = hash.substring(1);
                showSection(id);
            }
        });
    });
    const currentHash = window.location.hash.substring(1);
    if (currentHash && document.getElementById(currentHash)) {
        showSection(currentHash);
    } else {
        showSection("dashboard");
    }


    // --- 2. PROGRESS BAR LOGIC ---
    function updateProgress() {
        if(bar.dataset.auto === "false") return;

        let filled = 0;
        fields.forEach(f => {
            if (f.type === "file") {
                if (f.files.length > 0) filled++;
            } else if (f.value && f.value.trim() !== "") {
                filled++;
            }
        });

        let percent = Math.round((filled / fields.length) * 100);
        bar.style.width = percent + "%";
        bar.innerText = percent + "%";
    }

    fields.forEach(f => {
        f.addEventListener("input", updateProgress);
        f.addEventListener("change", updateProgress);
    });
});
function toggleEditMode(showEdit) {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    const actions = document.getElementById('profile-actions');

    if (showEdit) {
        viewMode.classList.add('d-none');
        editMode.classList.remove('d-none');
        actions.classList.add('d-none');
    } else {
        viewMode.classList.remove('d-none');
        editMode.classList.add('d-none');
        actions.classList.remove('d-none');
    }
}

function confirmDeleteProfile() {
    if (confirm("Are you sure you want to delete your profile? This will hide you from candidates.")) {
        // Create a hidden form to send a POST request for security
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/mentor/delete-profile';
        document.body.appendChild(form);
        form.submit();
    }
}


</script>
{% endblock %}